name: CMake

permissions:
  contents: write

on:
  push:
    branches: ["master"]
    tags:
      - 'v*'
  pull_request:
    branches: ["master"]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup zlib via vcpkg
      shell: pwsh
      run: vcpkg install zlib:x64-windows zlib:x64-windows-static

    - name: Cache Qt static build
      id: cache-qt-static
      uses: actions/cache@v4
      with:
        path: Qt6Static
        key: ${{ runner.os }}-Qt6Static-6.11.0

    - name: Download Qt static build
      if: steps.cache-qt-static.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri https://www.atarismwc.com/Qt6Static.7z -OutFile Qt6Static.7z
        7z x -oQt6Static Qt6Static.7z -y

    - name: Build static exe
      env:
        CMAKE_TOOLCHAIN_FILE: C:/vcpkg/scripts/buildsystems/vcpkg.cmake
      run: |
        cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build-static -DCMAKE_BUILD_TYPE=Release -DSTATIC_QT_DIR=${{ github.workspace }}/Qt6Static -DCFGEDITOR_BUILD_STATIC=ON
        cmake --build ${{ github.workspace }}/build-static --config Release

    - name: Install Qt (dynamic)
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.3'
        arch: 'win64_msvc2022_64'
        cache: true

    - name: Build dynamic exe
      run: |
        cmake -S ${{ github.workspace }} -B ${{ github.workspace }}/build-dynamic -DCMAKE_BUILD_TYPE=Release "-DCMAKE_PREFIX_PATH=${{ env.QT_ROOT_DIR }}"
        cmake --build ${{ github.workspace }}/build-dynamic --config Release

    - name: Create zip package
      run: python zip_script.py build-dynamic/Release

    - name: Copy zip for installer
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path packaging/windows/Properties
        Copy-Item CFGEditor.zip -Destination packaging/windows/Properties/CFGEditor.zip

    - name: Build installer
      run: msbuild packaging/windows/CFGEditorInstaller.csproj /p:Configuration=Release /p:Platform=AnyCPU

    - name: Upload static exe
      uses: actions/upload-artifact@v4
      with:
        name: CFGEditorPlusPlus-windows-static
        path: ${{ github.workspace }}/build-static/Release/CFGEditorPlusPlus.exe

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: ICFGEditor-windows
        path: packaging/windows/bin/Release/net48/ICFGEditor.exe

  build-linux:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pkg-config \
          libx11-xcb-dev libxcb1-dev libxcb-cursor-dev libxcb-icccm4-dev \
          libxcb-image0-dev libxcb-keysyms1-dev libxcb-randr0-dev \
          libxcb-render0-dev libxcb-render-util0-dev libxcb-shape0-dev \
          libxcb-shm0-dev libxcb-sync-dev libxcb-util-dev libxcb-xfixes0-dev \
          libxcb-xinerama0-dev libxcb-xkb-dev \
          libxkbcommon-dev libxkbcommon-x11-dev \
          libfontconfig-dev libfreetype-dev \
          libgl-dev libegl-dev \
          libfuse2 ninja-build

    - name: Install Qt (dynamic)
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.3'
        arch: 'linux_gcc_64'
        cache: true

    - name: Download linuxdeploy tools
      run: |
        wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage" -O linuxdeploy-x86_64.AppImage
        wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage" -O linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-qt-x86_64.AppImage

    - name: Build
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release "-DCMAKE_PREFIX_PATH=${{ env.QT_ROOT_DIR }}"
        cmake --build build --parallel

    - name: Package AppImage
      env:
        QMAKE: ${{ env.QT_ROOT_DIR }}/bin/qmake
        OUTPUT: ${{ github.workspace }}/CFGEditorPlusPlus-x86_64.AppImage
        APPIMAGE_EXTRACT_AND_RUN: '1'
      run: |
        export PATH="${{ github.workspace }}:$PATH"
        ./linuxdeploy-x86_64.AppImage \
          --appdir AppDir \
          --executable build/CFGEditorPlusPlus \
          --desktop-file CFGEditorPlusPlus.desktop \
          --icon-file VioletEgg.png \
          --plugin qt \
          --output appimage

    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: CFGEditorPlusPlus-AppImage
        path: CFGEditorPlusPlus-x86_64.AppImage

  release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    if: startsWith(github.ref, 'refs/tags')

    steps:
    - name: Download Windows static exe
      uses: actions/download-artifact@v4
      with:
        name: CFGEditorPlusPlus-windows-static
        path: release-files/

    - name: Download Windows installer
      uses: actions/download-artifact@v4
      with:
        name: ICFGEditor-windows
        path: release-files/

    - name: Download Linux AppImage
      uses: actions/download-artifact@v4
      with:
        name: CFGEditorPlusPlus-AppImage
        path: release-files/

    - name: Create release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        prerelease: false
        files: release-files/*
